#!/bin/sh

help() {
	echo "fytm - fzf youtube media files

USAGE:
	fytm [OPTION]... [CHANNEL_FILE]

OPTIONS:
	-h  show this help message

CHANNEL_FILE ends with .channel.txt extension"
}

err() { printf 'fytm: %s\n' "$@" >&2; exit 1; }
while getopts 'Ovh' o; do case "$o" in
	O) Oflag=0 ;;
	h) help >&2; exit ;;
	*) err "invalid option -- '$OPTARG'" ;;
esac done
shift $((OPTIND - 1))

if [ "$Oflag" = 0 ]; then
	mpv "$(find "$CHANNEL_DIR" -regextype posix-extended \
		-regex ".*$*\.(mkv|webm|mp4)")"
	exit
fi

[ "$#" -lt 1 ] && help >&2 && exit 1
file="$1"

[ "$file" = "${file%.channel.txt}" ] &&
	err "not an *.channel.txt file: $file"

export CHANNEL_DIR="../${file%.channel.txt}"

cat "$file" | fzf --bind 'enter:execute(fytm -O {})'
